<!DOCTYPE html>
<html lang="en">
<head id="shared-head">
    <link rel="stylesheet" href="/src/styles/styles.css">

    <style>
        .particles{
            position:fixed;
            left:0;
            top:0;
            width: 100%;
            height: 100dvh;

            z-index: -1;
        }

        .square{
            position:absolute;
            bottom:-100px;

            border-radius: 10px;

            background-color: var(--bg2);

            box-shadow: 0 3px 15px var(--bg3) inset;

            animation: float 5s linear forwards;
        }

        .dark .square{
            background-color: var(--bg4);
        }

        @keyframes float{
            from{
                transform: translateY(0) rotateZ(0deg);
            }

            to{
                transform:translateY(calc(-100dvh - 100px))  rotateZ(360deg);
            }
        }
    </style>
</head>
<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        fetch('../templates/head.html')
            .then(resp => resp.text())
            .then(html => {
                document.getElementById('shared-head').innerHTML += html
        })

        function toggle(id){
            const x = $("#" + id)
            if(x.is(":visible")){
                x.addClass("c")
                setTimeout(() => {
                    x.removeClass("c")
                    x.hide()
                }, 300)
            } else {
                x.addClass("o")
                x.show();
                setTimeout(() => {
                    x.removeClass("o")
                }, 300)
            }
        }

        function toggleFloating(id1, id2){
            toggle(id1)
            toggle(id2)
        }

        window.addEventListener('load', () => {
            setInterval(() => {
                var w = Math.random() * 100
                var x = $(".particles").append(`<div class="square" style="left:${Math.random() * 110 - 10}%; width:${w}px; height:${w}px"></div>`)

                remove(x.children().last())
            }, 600)
        })

        async function remove(x){
            setTimeout(() => {
                x.remove()
            }, 5000)
        }
    </script>
    <script src="/src/js/navbar.js"></script>

    <div class="navbar">
    </div>

    <div class="panel wide center glassmorphism">
        <h1>Get Ready!</h1>

        <p>When you're ready, start the game!</p>
        <input type="text" id="username-input" placeholder="Enter your username" style="margin-bottom: 10px; padding: 10px; border-radius: 8px; border: 1px solid var(--bg3); background: var(--bg2); color: var(--text);">
        <button onclick="startGame()">Start Game</button>
    </div>

    <script>
        function startGame() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Please enter a username!');
                return;
            }
            localStorage.setItem('eyespy_username', username);
            toggleFloating('video-layout', 'video-panel');
            init();
        }
    </script>

    <div class="floating" id="video-layout">
        <div class="panel" id="video-panel" style="width:100%;box-sizing: border-box;max-height:100dvh;overflow-y: auto;">
            <button class="close normal" onclick="toggleFloating('video-layout', 'video-panel'); endAgent()"><i class="material-symbols-rounded">close</i></button>
            
            <div class="stats">
                <div>
                    <img src="/src/media/heart.svg" alt="Tries left">
                    <p><b id="tries-count">0</b> tries</p>
                </div>

                <div>
                    <img src="/src/media/coin.svg" alt="points count">
                    <p><b id="points-count">300</b> points</p>
                </div>
            </div>

            <div class="panel" id="game">
                <canvas id="canvas"></canvas>

                <div class="loading" id="riddle-loading" style="display: none;"></div>

                <div class="holder">
                    <div>
                        <p id="riddle"></p>
                    </div>
                    <div class="btn-input">
                        <input type="text" id="voice-input" placeholder="What am I?">
                        <button id="mic-btn" class="clear" style="right:75px;"><i class="material-symbols-rounded">mic</i></button>
                        <button onclick="inputAnswer()"><i class="material-symbols-rounded">arrow_forward</i></button>
                    </div>
                </div>
            </div>

            <div class="panel" id="camera">
                <div class="panel" id="voice-mode" style="display: none;border:none;">
                    <h2>Voice Mode</h2>
                    <p>Talk to AI about your surroundings. <b>Click "Capture" to start!</b></p>
                    <div class="sound-waves" style="--w: var(--volume);">
                        <i class="material-symbols-rounded">mic</i>
                    </div>
                    <script>
                        navigator.mediaDevices.getUserMedia({ audio: true })
                            .then(stream => {
                                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                                const analyser = audioContext.createAnalyser();
                                const microphone = audioContext.createMediaStreamSource(stream);
                                microphone.connect(analyser);
                                analyser.fftSize = 256;
                                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                                function updateVolume() {
                                    analyser.getByteFrequencyData(dataArray);
                                    const volume = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
                                    const normalizedVolume = Math.min(Math.max(volume / 255, 0), 1); // Normalize to 0-1
                                    document.documentElement.style.setProperty('--volume', `${normalizedVolume * 60}px`); // Adjust scale as needed
                                    requestAnimationFrame(updateVolume);
                                }

                                updateVolume();
                            })
                            .catch(err => console.error('Error accessing microphone:', err));
                    </script>
                </div>

                <div class="loading"></div>
        
                <video id="video" autoplay muted>
                </video>

                <button id="snap"><i class="material-symbols-rounded">photo_camera</i> Capture</button>

                <div class="btn-group">
                    <label class="toggle">
                        <input type="checkbox" onchange="toggleVoice()">
                        <span class="slider"></span>
                    </label>
                    <label>Voice Mode</label>
                </div>
            </div>
        </div>
    </div>

    <div class="floating" id="answer-layout">
        <div class="panel" id="answer-panel">
            <img src="/src/media/coin.svg" alt="Image coin reward correct" class="coin">
            <h2>Correct!</h2>      
            
            <p>The answer was <b><span id="answer"></span></b>.</p>

            <div class="panel wide">
                <h2>Fun fact</h2>
                <p id="fun-fact">
                    <!-- fun fact goes here -->
                </p>
            </div>

            <p>Rounds get harder as you go on. <b>Tip: take a picture of something new for a bigger challenge!</b></p>
            <button onclick="nextRound()">Next Round <i class="material-symbols-rounded">arrow_forward</i></button>
        </div>
    </div>

    <div class="floating" id="wrong-layout">
        <div class="panel" id="wrong-panel">
            <img src="/src/media/incorrect.svg" alt="Image icon incorrect" class="coin">
            <h2>Incorrect</h2>
            <p>You still have <b><span id="tries">3</span></b> tries.</p>
            <button onclick="tryAgain()">Try again <i class="material-symbols-rounded">cached</i></button>
        </div>
    </div>

    <div class="floating" id="dead-layout">
        <div class="panel" id="dead-panel">
            <img src="/src/media/death.svg" alt="Image icon incorrect" class="coin">
            <h2>You Lost! ðŸ’€</h2>
            <p>You ran out of tries! The answer was <b><span id="death-answer"></span></b></p>
            <button onclick="window.location.reload()">Play Again</button>
            <button class="normal" onclick="window.location.reload()">Cancel</button>
        </div>
    </div>

    <div class="panel glassmorphism">
        <h2>How to Play</h2>
        <p>It's simple!</p>
        <ol>
            <li>Click start!</li>
            <li>Take a picture of something!</li>
            <li>Wildeyes with ask a riddle about something in that image.</li>
            <li>Try and identify it in 3 tries!</li>
        </ol>
    </div>

    <div class="panel glassmorphism">
        <h2>Voice Mode</h2>
        <p>Tired of staring at text? Leisurely talk to a human-like AI with I spy.</p>
        <ol>
            <li>Click start!</li>
            <li>Take a picture of something!</li>
            <li>Enable voice mode.</li>
            <li>Have fun!</li>
        </ol>
    </div>

    <script src="/src/js/game.js" type="module"></script>

    <div class="particles">

    </div>
</body>
</html>
